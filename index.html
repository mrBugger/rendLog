<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rend Log</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        textarea {
            width: 100%;
            height: 150px;
            margin-bottom: 10px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
        }
        .rend-info {
            margin-top: 20px;
        }
        .cooldown {
            color: red;
        }
        .free-layer {
            color: green;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Rend Log</h1>
    <textarea id="rendInput" placeholder="Paste your Rend log here..."></textarea>
    <button onclick="calculateCooldowns()">Calculate</button>

    <div id="rendInfo" class="rend-info"></div>

    <script>
        function calculateCooldowns() {
            const input = document.getElementById('rendInput').value;
            const lines = input.split('\n');
            const rendInfoDiv = document.getElementById('rendInfo');
            rendInfoDiv.innerHTML = ''; // Clear previous results

            let activeCooldowns = 0; // Track the number of layers on cooldown
            const combinedEntries = {}; // Track entries by timestamp

            lines.forEach(line => {
                if (line.trim() === '') return;

                // Extract time and cooldown information
                const timeMatch = line.match(/Today (\d{1,2}:\d{2}(?:am|pm))/);
                const droppedMatch = line.match(/Dropped (\d+ hours? \d+ minutes? \d+ seconds? ago)/);
                const cooldownMatch = line.match(/Cooldown (\d+h \d+m \d+s)/);

                if (timeMatch) {
                    const rendTime = timeMatch[1];
                    const rendDateTime = parseTime(rendTime); // Convert to Date object
                    const cooldown = cooldownMatch ? parseCooldown(cooldownMatch[1]) : 3 * 3600; // Default cooldown is 3 hours
                    const cooldownEnd = new Date(rendDateTime.getTime() + cooldown * 1000);

                    // Combine entries with the same timestamp
                    if (!combinedEntries[rendTime]) {
                        combinedEntries[rendTime] = {
                            rendDateTime,
                            cooldownEnd,
                            onCooldown: cooldownEnd > new Date(),
                        };
                    } else {
                        // If multiple entries have the same timestamp, keep the one with the longest cooldown
                        if (cooldownEnd > combinedEntries[rendTime].cooldownEnd) {
                            combinedEntries[rendTime].cooldownEnd = cooldownEnd;
                            combinedEntries[rendTime].onCooldown = cooldownEnd > new Date();
                        }
                    }
                }
            });

            // Process combined entries
            Object.keys(combinedEntries).forEach(rendTime => {
                const { cooldownEnd, onCooldown } = combinedEntries[rendTime];
                const infoDiv = document.createElement('div');
                infoDiv.innerHTML = `Rend popped today ${rendTime} `;

                if (onCooldown) {
                    activeCooldowns++; // Increment the number of active cooldowns
                    const cooldownSpan = document.createElement('span');
                    cooldownSpan.className = 'cooldown';
                    cooldownSpan.dataset.cooldownEnd = cooldownEnd.toISOString();
                    cooldownSpan.innerText = `(cooldown ${formatTime(cooldownEnd - new Date())})`;
                    infoDiv.appendChild(cooldownSpan);
                } else if (3 - activeCooldowns > 0) {
                    // Only show "free layer" if there is at least one free layer
                    const freeLayerSpan = document.createElement('span');
                    freeLayerSpan.className = 'free-layer';
                    freeLayerSpan.innerText = 'free layer';
                    infoDiv.appendChild(freeLayerSpan);
                }

                rendInfoDiv.appendChild(infoDiv);
            });

            // Display the number of free layers
            const freeLayers = 3 - activeCooldowns; // Calculate free layers
            const freeLayersDiv = document.createElement('div');
            freeLayersDiv.className = 'free-layer';
            freeLayersDiv.innerText = `Free layers: ${freeLayers}`;
            rendInfoDiv.appendChild(freeLayersDiv);

            // Update cooldowns every second
            setInterval(updateCooldowns, 1000);
        }

        function parseTime(timeStr) {
            const [time, modifier] = timeStr.split(/(am|pm)/);
            let [hours, minutes] = time.split(':');
            hours = parseInt(hours);
            minutes = parseInt(minutes);

            if (modifier === 'pm' && hours < 12) hours += 12;
            if (modifier === 'am' && hours === 12) hours = 0;

            const date = new Date();
            date.setHours(hours, minutes, 0, 0);
            return date;
        }

        function parseCooldown(cooldownStr) {
            const parts = cooldownStr.split(' ');
            let totalSeconds = 0;
            parts.forEach(part => {
                if (part.includes('h')) totalSeconds += parseInt(part) * 3600;
                if (part.includes('m')) totalSeconds += parseInt(part) * 60;
                if (part.includes('s')) totalSeconds += parseInt(part);
            });
            return totalSeconds;
        }

        function formatTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function updateCooldowns() {
            const cooldownSpans = document.querySelectorAll('.cooldown');
            let activeCooldowns = 0;

            cooldownSpans.forEach(span => {
                const cooldownEnd = new Date(span.dataset.cooldownEnd);
                const remaining = cooldownEnd - new Date();
                if (remaining > 0) {
                    activeCooldowns++; // Count active cooldowns
                    span.innerText = `(cooldown ${formatTime(remaining)})`;
                } else {
                    span.className = 'free-layer';
                    span.innerText = 'free layer';
                }
            });

            // Update the number of free layers
            const freeLayers = 3 - activeCooldowns;
            const freeLayersDiv = document.querySelector('.free-layer:last-child');
            if (freeLayersDiv) {
                freeLayersDiv.innerText = `Free layers: ${freeLayers}`;
            }
        }
    </script>
</body>
</html>
